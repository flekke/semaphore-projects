---
- name: Prepare and run Terraform
  hosts: localhost
  gather_facts: no

  tasks:
    - name: Ensure openstack config directory exists
      file:
        path: /home/semaphore/.config/openstack
        state: directory
        mode: '0755'
        recurse: yes

    - name: Create clouds.yaml for OpenStack provider
      copy:
        dest: /home/semaphore/.config/openstack/clouds.yaml
        content: |
          clouds:
            openstack:
              auth:
                auth_url: https://pegasus.sky.oslomet.no:5000
                username: "yolim4304@oslomet.no"
                project_id: 0903c452034f4d838edeb54a00c5ee52
                project_name: "ACIT4430_V25_io2"
                user_domain_name: "oslomet"
              region_name: "Pilestredet"
              interface: "public"
              identity_api_version: 3

    - name: Clone Terraform code from GitHub
      git:
        repo: https://github.com/flekke/semaphore-projects.git
        dest: /tmp/tf-project
        version: main
        force: yes
      environment:
        GIT_TERMINAL_PROMPT: ""

    - name: Run terraform init
      shell: terraform init
      args:
        chdir: /tmp/tf-project/terraform
      environment:
        OS_CLIENT_CONFIG_FILE: /home/semaphore/.config/openstack/clouds.yaml

    - name: Run terraform apply
      shell: terraform apply -auto-approve
      args:
        chdir: /tmp/tf-project/terraform
      environment:
        OS_CLIENT_CONFIG_FILE: /home/semaphore/.config/openstack/clouds.yaml
